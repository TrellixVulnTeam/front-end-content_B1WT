# TCP/IP协议

## IP协议

IP协议位于网络层，作用是把各种数据包传送给对方。
要保证确实传送到对方那里，则需要满足各类条件，其中两个重要的条件是 IP 地址和 MAC 地址

IP 地址和 MAC 地址指明了节点被分配到的地址，MAC 地址是指网卡所属的固定地址，IP 地址可以和 MAC 地址进行配对
IP 地址可变换，但 MAC 地址基本上不会更改

### ip 和 TCP 区别

TCP 比 IP 高一层，IP 是为 TCP 服务的，TCP将数据封装好后给到下一个 IP

### 使用 ARP 协议用 MAC 地址进行通信

1. IP 间的通信依赖MAC地址

2. ARP 协议是一种用来解释地址的协议，根据通信方的 IP （网络地址）就可以反查出对应方的 MAC (物理地址)

## TCP协议

TCP 协议提供一种面向连接的、可靠的字节流服务

### TCP 协议可靠的原因

1. 数据包校验：目的是检测数据在传输过程中的任何变化
发送方将整个报文段分为多个16位的段，然后将所有段进行反码相加，将结果存放在检验字段中，接收方用相同的方法进行计算，如最终结果为检验字段所有位全为1，则正确；否则存在错误
若校验出包有错，则丢弃报文段并且不给出响应，这时 TCP 发送数据端超时后会重发数据；

2. 对失序数据包重排序：既然 TCP 报文段作为 IP 数据报来传输，而 IP 数据报的到达可能会失序，因此 TCP 报文段的到达也可能会失序
TCP 将对失序数据进行重新排序，然后才交给应用层；

3. 丢弃重复数据：对于重复数据，能够丢弃重复数据；

4. 应答机制：当 TCP 收到从 TCP 连接另一端的数据，它将发送一个确认，这个确认不是立即发送，通常将推迟几分之一秒；

5. 超时重传：当 TCP 发出一个报文段后，它启动一个定时器，等待目的端确认收到这个报文段
如果不能及时收到一个确认，将重发这个报文段；

6. 流量控制：TCP 连接的每一方都有固定大小的缓冲空间
**流量控制作用于接收方，保证接收方来得及接收数据**
TCP 接收端只允许另一端发送接收端缓冲区所能接纳的数据，这可以防止较快主机致使较慢主机的缓冲区溢出(抑制发送端发送数据的速率，以便接收端来得及接收)
流量控制通过滑动窗口机制实现，接收方通知发送方自己的接收窗口可以接收数据，发送方根据接收方的接收窗口调整自己的滑动窗口大小
TCP会话的发送方任何时候在其发送缓冲内的数据，都可以分为四类：
1、已经发送并且得到接收端回应的
2、已经发送还没有得到接收端回应的
3、未发送但接收端允许发送的
4、未发送其由于达到window大小，接收端不允许发送的
2和3 类，这两部分数据组成发送窗口，当收到接收方新的 ack 对于发送窗口中后续字节的确认时，窗口就会滑动
当滑动窗口的容量减到 0 时，发送端会在一定时间后向接收方发送一个窗口探测报文(仅携带1个字节数据)，而接收方会在这个探测报文给出现在的窗口值

7. 拥塞控制：当网络延迟增加时，TCP会进行超时重传数据，然而重传会导致网络的负担更重，于是会导致更大的延迟以及更多的丢包，从而形成“网络风暴”
拥塞控制机制就是用于应对这种情况
**拥塞控制作用于发送方，防止过多的数据阻塞网络，避免出现网络负载过大的情况**

拥塞控制原理：在发送端定义了一个“拥塞窗口”用来调节所要发送的数据量，在发送数据时，将拥塞窗口与接收窗口容量做比较，取较小者作为发送数据量的上限
拥塞控制算法方法：
1、慢开始：初始化时拥塞窗口容量为1，先探测一下网络的拥塞程度。每过一个往返时间 RTT 就把窗口容量乘二，当窗口容量大于阈值时就会启动拥塞避免算法
2、拥塞避免：每过一个往返时间 RTT 就把发送方的拥塞窗口容量加1，而不是加倍，让拥塞窗口线性地缓慢增长
**无论是慢开始阶段还是拥塞避免阶段，只要发送方判断出网络出现拥塞(没有收到确认信息)，就会把慢开始阈值设置为当前出现拥塞时窗口的一半，然后将拥塞窗口设为1，重新进入慢开始阶段**
3、快重传：发送方只要一连收到三个重复确认信息时就立即重传对方尚未收到的报文段，而不必继续等待设置的重传计时器时间到期
4、快恢复：配合快重传使用，当发送方连续收到三个重复确认时，把窗口容量和慢开始阈值减为当前窗口容量的一半。但是之后不执行慢开始算法，而是执行拥塞避免算法
考虑到如果网络出现拥塞的话就不会收到好几个重复的确认，所以发送方认为网络可能没有出现拥塞。所以此时不执行慢开始算法
![avatar](https://img-blog.csdnimg.cn/20190731184935595.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDMxNDA2,size_16,color_FFFFFF,t_70)

## TCP/IP通信传输流

发送端在层与层之间传输数据时，每经过一层必定会加上一个该层的首部信息
反之，接收端在层与层之间传输数据时，每经过一层会把相关的首部信息去掉

## TCP 粘包问题

粘包发生在发送缓存区或接收缓冲区中，从缓冲区中读取数据是读取整个缓冲区中的数据，那么就有可能第一个数据的尾部和第二个数据的头部同时存在缓冲区，而 TCP 是流式的，数据无边界，这时发生粘包

### 发送方产生粘包

当发送的数据包过小时，TCP 会默认启用 Nagle 算法，将这些较小的数据包进行合并发送；这个合并过程是在发送缓冲区中进行的，也就是说数据发送时它已经是粘包的状态了

### 接收方产生粘包

当接收缓冲区中有数据时，我们会调用读取数据函数对缓冲区数据进行读取。但如果不能及时把缓冲区中数据取出来，而下一个数据又到来并放入缓冲区尾部时，就会发生粘包(接收数据速度 > 读取数据速度)

### 粘包解决方案

对发送方来说，可以禁用 nagle 算法
对接收方来说，可以在发送方的头信息上加上整个数据的长度，接收方在接收数据时解析头信息，根据长度来接收

## 5类IP地址

网络地址：用于识别主机所在的网络
主机地址：用于识别该网络中的主机

1. A 类地址 (保留给政府机构)
第一个八位段为网络地址，其它为主机地址，第一个八位段首位一定为 0
范围：1.0.0.1—126.155.255.254；

私有地址和保留地址：
10.X.X.X是私有地址（所谓的私有地址就是在互联网上不使用，而被用在局域网络中的地址）。
127.X.X.X是保留地址，用做循环测试用的。
2. B 类地址 (分配给中等规模的公司)
第一个八位段和第二个八位段为网络地址，其它为主机地址，第一个八位段首位一定为 10
范围：128.0.0.1—191.255.255.254;

私有地址和保留地址:
172.16.0.0—172.31.255.255是私有地址
169.254.X.X是保留地址。如果你的IP地址是自动获取IP地址，而你在网络上又没有找到可用的DHCP服务器。就会得到其中一个IP。
3. C 类地址 (分配给任何需要的人)
前三个八位段为网络地址，第4个个字节为主机地址，第一个八位段首位一定为110。
范围：192.0.0.1—223.255.255.254。
私有地址：
192.168.X.X是私有地址。
4. D 类地址 (用于特殊用途,又称做广播地址)
不分网络地址和主机地址，第一个八位段首位一定为1110。
范围：224.0.0.1—239.255.255.254
5. E 类地址 (暂时保留)
不分网络地址和主机地址，第一个八位段首位一定为11110。
范围：240.0.0.1—255.255.255.254
