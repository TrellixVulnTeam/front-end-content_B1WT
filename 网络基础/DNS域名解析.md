# DNS 域名解析

查找出客户端输入的域名对应的IP地址，并将IP地址由服务端发送给客户端

## 查找域名对应的 IP 地址到显示页面具体过程

假设用户在浏览器中输入 'https://www.baidu.com';

1. 浏览器搜索自己的 DNS 缓存
当浏览器发现请求的资源已经在浏览器缓存中存有副本，它会拦截请求，返回该资源的副本，并直接结束请求，而不会再去源服务器重新下载
如果缓存查找失败，就会进入网络请求过程了

2. 搜索系统缓存。对操作系统的 hosts 文件进行查找（Windows 环境下的域名与 IP 地址对应表）；如果没有命中，进入下一步；

3. 通过 LDNS 查询 ip 地址；
3.1 操作系统将域名发送至 LDNS （本地域名服务器，一般在当前城市的某个地方，距离用户不远），LDNS 查询自己的 DNS 缓存（一般命中率在 80% 左右），找到则返回结果，失败则发起一个迭代 DNS 解析请求；
3.2 LDNS 向 Root Name Server（根域名服务器，如com、net、im 等的顶级域名服务器的地址）发起请求，Root Name Server 找到则返回结果，失败则返回相应顶级域名服务器的地址，让LDNS继续向上查询；
3.3 LDNS 向 顶级域名服务器(com) 发起请求，顶级域名服务器根据映射关系表若找到目标 IP 则返回给 LDNS，失败则返回相应二级域名服务器的地址，让LDNS继续向上查询；
3.4 LDNS 向 二级域名服务器(baidu.com) 发起请求，二级域名服务器将查询到的 IP 地址返回给 LDNS；
3.5 LDNS 将得到的 IP 地址返回给操作系统，同时自己也将 IP 地址缓存起来；操作系统将 IP 地址返回给浏览器，同时自己也将 IP 地址缓存起来。

4. 拿到对应的 IP 地址后，浏览器会以一个随机端口向服务器发起 TCP 请求，最终建立了TCP/IP的连接通道(建立连接TCP的三次握手)；

5. 建立了TCP连接之后，发起一个http请求。
后端从在固定的端口接收到TCP报文开始，它会对TCP连接进行处理，对HTTP协议进行解析，并按照报文格式进一步封装成HTTP Request对象，供上层使用；

6. 服务器收到了http请求后，它会把它的处理结果返回，也就是返回一个HTTP响应；
若返回的是 301 或 302 状态码，则需要进行重定向，去请求新的网址

7. 浏览器接收到 HTML 文档后，开始加载并渲染页面。
在浏览器显示HTML时，如果要获取其他地址内容的标签，如图片、CSS、JS文件等，都要经历一个和HTML读取类似的过程，所以浏览器会在DNS中查找这些域名，发送请求，重定向等等...

## DNS 查询与传输协议

DNS 在查询的过程中使用的是 UDP 协议，而在进行区域传输时使用的是 TCP 协议

原因：
采用 UDP 协议使得 DNS 解析时间更快，省去了握手与挥手的时间，若解析的是一个冷门网站，则需要根域名服务器、一级域名服务器、二级域名服务器迭代查询，若是 TCP 会耗费三轮的握手挥手时间
UDP 传输 DNS 的报文有长度限制，一般是 512 个字节。当 DNS 传输的应答超过 512 字节时会将应答截断至 512 字节，导致 DNS 应答不完整，所以当传输应答长度较大时会采用 TCP 进行传输
