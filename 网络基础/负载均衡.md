# 负载均衡

负载均衡是一种计算机技术，用来在多个计算机（计算机集群）、CPU 或其他资源中分配负载，以达到最优化资源使用、最小化响应时间、同时避免过载的目的

负载均衡的工作：
将负载（工作任务，访问请求）进行平衡、分摊到多个操作单元（服务器，组件）上进行执行
是实现高性能，高可用，高扩展性的终极解决方案

## 负载均衡分类

- 四层负载均衡
四层负载均衡工作在 OSI 模型的第四层，即传输层
传输层只有 TCP/UDP 协议，这两种协议中除了包含 源IP、目的IP，还包含源端口号和目的端口号
四层负载均衡服务器在接收到客户端请求后，通过修改数据包的地址信息(IP+端口号)将流量转发到应用服务器

- 七层负载均衡
七层负载均衡工作在 OSI 模型的第七层，即应用层
应用层协议较多，常用 http/dns等。七层负载就可基于这些协议进行负载，这些应用层协议中会包含很多有意义的内容
比如一个负载均衡服务器除了根据IP加端口号进行负载外，还可根据 URL、浏览器类别、语言来决定是否要进行负载均衡

## 负载均衡软件工具

- LVS：用来做四层负载均衡
LVS (Linux Virtual Server，Linux虚拟服务器)
通过 LVS 提供的负载均衡技术和 Linux 操作系统实现一个高性能、高可用的服务器群集，它具有良好可靠性、可扩展性和可操作性，从而以低廉的成本实现最优的服务性能

- Nginx：用来做七层负载均衡
Nginx 是一个网页服务器，它能反向代理 HTTP、HTTPS、SMTP等协议连接，以及一个负载均衡器和一个 HTTP缓存

- HAProxy：用来做七层负载均衡
HAProxy 是一个C语言编写的开源软件，其提供高可用性、负载均衡，以及基于 TCP 和 HTTP 的应用程序代理

## 负载均衡算法

负载均衡服务器在决定将请求转发到具体哪台应用服务器时，是通过负载均衡算法来实现的
负载均衡算法分为 静态负载均衡算法 和 动态负载均衡算法

### 静态负载均衡算法

- 轮询：负载均衡服务器将请求通过顺序循环连接每个服务器，当其中某个服务器发生第二到七层故障时，会将其从顺序循环队列中取出，不参加下一次轮询，直到恢复正常
- 加权：给每个服务器分配一个加权值，负载均衡服务器将用户的请求按照比例分配给各服务器
当其中某个服务器发生第二到七层故障时，会将其从服务器队列中取出，不参加下一次用户请求分配，直到恢复正常
- ip-hash：每个请求按请求方的 ip 地址进行分配，这样每个访客固定访问一个后端服务器，可以解决 session 的问题
- 优先权：给所有服务器分组，每个组定义优先权。负载均衡服务器将用户请求分配给优先级最高的服务器组(同组内的服务器通过轮询或加权算法分配请求)
当最高优先级服务器组所有服务器都出故障时，才会将请求分配给次优先级的服务器组

### 动态负载均衡算法

- 最少请求方式：将新的请求分配给进行最少请求处理的服务器，当其中某个服务器发生第二到七层故障时，会将其从服务器队列中取出，不参加下一次用户请求分配，直到恢复正常
- 最快模式：将请求分配给响应最快的服务器，当其中某个服务器发生第二到七层故障时，会将其从服务器队列中取出，不参加下一次用户请求分配，直到恢复正常
- 观察模式：请求数目和响应时间以这两项的最佳平衡为依据为新的请求选择服务器，当其中某个服务器发生第二到七层故障时，会将其从服务器队列中取出，不参加下一次用户请求分配，直到恢复正常
- 预测模式：负载均衡服务器对服务器当前的性能指标进行检测，进行预测分析，选择一个在下一时间片内性能达到最佳的服务器响应用户的请求
